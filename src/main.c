/*
 * This file is part of cve-check-tool
 *
 * Copyright © 2015-2016 Intel Corporation
 *
 * cve-check-tool is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 */

#include <nica.h>
#include <stdio.h>
#include <stdlib.h>

#include "util.h"

/**
 * Provide main() like functionality in a callback
 */
typedef int (*command_callback)(int argc, char **argv);

/**
 * Helper to wrap simple "sub commands"
 */
typedef struct SubCommand {
        command_callback callback; /**< Callback to execute */
        const char *blurb;         /**< Blurb for this command */
} SubCommand;

/**
 * Print usage and move on */
static void print_usage(void)
{
        fprintf(stderr, "Usage printer not yet implemented\n");
}

/**
 * Print version and exit
 */
static int print_version(__unused__ int argc, __unused__ char **argv)
{
        printf(
            "Copyright © 2015-2016 Intel Corporation\n\n"
            "cve-check-tool is free software; you can redistribute it and/or\n"
            "modify it under the terms of the GNU General Public License as\n"
            "published by the Free Software Foundation; either version 2 of\n"
            "the License, or (at your option) any later version.\n");
        return EXIT_SUCCESS;
}

int main(int argc, char **argv)
{
        autofree(NcHashmap) *commands = NULL;
        const char *command = NULL;
        SubCommand *cmd = NULL;

        commands = nc_hashmap_new(nc_string_hash, nc_string_compare);
        /* Update command */
        nc_hashmap_put(commands,
                       "update",
                       &(SubCommand){.callback = NULL,
                                     .blurb = "Update the data sources" });

        /* Help command */
        nc_hashmap_put(commands,
                       "help",
                       &(SubCommand){.blurb = "Display this help message" });

        /* Version command */
        nc_hashmap_put(commands,
                       "version",
                       &(SubCommand){.callback = print_version,
                                     .blurb = "Show version and quit" });
        if (argc < 2) {
                print_usage();
                return EXIT_SUCCESS;
        }

        /* Check for the command */
        command = argv[1];
        cmd = nc_hashmap_get(commands, command);
        if (!cmd) {
                fprintf(stderr, "Unknown command: %s\n\n", command);
                print_usage();
                return EXIT_FAILURE;
        }

        /* While in development, check for implementation.. */
        if (!cmd->callback) {
                fprintf(stderr, "%s: not yet implemented\n", command);
                return EXIT_FAILURE;
        }

        /* TODO: Shift offset */
        return cmd->callback(argc, argv);
}
