PRAGMA journal_mode=WAL;

--
--  This file is part of cve-check-tool
--
-- Copyright Â© 2015-2016 Intel Corporation
--
-- cve-check-tool is free software; you can redistribute it and/or modify
-- it under the terms of the GNU General Public License as published by
-- the Free Software Foundation; either version 2 of the License, or
-- (at your option) any later version.
--

-- Construct main tables if they don't exist
CREATE TABLE IF NOT EXISTS CVE_IDS (HASH INTEGER UNIQUE PRIMARY KEY, ID VARCHAR(17), SUMMARY TEXT, SCORE TEXT, MODIFIED INTEGER, VECTOR TEXT);
CREATE TABLE IF NOT EXISTS PRODUCTS (HASH INTEGER UNIQUE PRIMARY KEY, VENDOR TEXT, PRODUCT TEXT);
CREATE TABLE IF NOT EXISTS VERSIONS (HASH INTEGER UNIQUE PRIMARY KEY, PRODUCT_ID INTEGER, CVE_ID INTEGER, VERSION TEXT);

-- We store our modification records here --
CREATE TABLE IF NOT EXISTS NVD_INDEXES (NVD_YEAR INTEGER UNIQUE PRIMARY KEY, MODIFIED INTEGER);

-- Construct the main view if it doesn't exist
CREATE VIEW IF NOT EXISTS CVE_VIEW AS SELECT c.ID as CVE_ID, c.SUMMARY, c.MODIFIED, c.SCORE, c.VECTOR, p.HASH as PHASH, p.VENDOR, p.PRODUCT, v.VERSION, v.HASH as VHASH
FROM CVE_IDS c INNER JOIN VERSIONS v on c.HASH = v.CVE_ID INNER JOIN PRODUCTS p ON v.PRODUCT_ID = p.HASH;


-- Speed up secondary CVE inserts
CREATE INDEX IF NOT EXISTS CVE_MOD_IDX on CVE_IDS (HASH, MODIFIED);

-- For testing only
-- INSERT INTO cve_insert VALUES ("CVE-2012-1234", "It hurt.", 12, "5.0", "Bad", 012345, "BadVendor", "BadProduct", "Version669293237", 1234);
-- INSERT INTO cve_insert VALUES ("CVE-2012-1234", "It hurt.", 12, "5.0", "Bad", 012345, "BadVendor", "BadProduct", "Version3", 9872);
