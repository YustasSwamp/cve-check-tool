/*
 * This file is part of cve-check-tool
 *
 * Copyright Â© 2015-2016 Intel Corporation
 *
 * cve-check-tool is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * As an additional permission, the right to link to OpenSSL is granted.
 */

#define _GNU_SOURCE
#include <check.h>
#include <nica.h>
#include <stdlib.h>

#include "config.h"
#include "util.h"

START_TEST(cve_common_parser)
{
        const char *path = TOP_DIR "/tests/data/common/nvdcve-2.0-2002.meta";
        autofree(NcHashmap) *map = NULL;
        const char *val = NULL;
        const char *good_keys[] = { "lastModifiedDate", "size", "zipSize", "gzSize", "sha256" };
        const char *bad_keys[] = { "rudolph", "the", "red", "nosed", "reindeer" };
        const char *hash = "abc1c569de5e3e612fb6e0045cfa6859aa5cfc6282ed0f6db166120effae4843";

        map = cve_parse_delim_file(path, ':');
        fail_if(!map, "Failed to parse known file\n");

        val = nc_hashmap_get(map, "sha256");
        fail_if(!streq(val, hash), "Failed to get correct value from mapping");

        for (int i = 0; i < ARRAY_SIZE(good_keys); i++) {
                fail_if(!nc_hashmap_contains(map, good_keys[i]),
                        "Config file doesn't contain expected key");
        }

        for (int i = 0; i < ARRAY_SIZE(bad_keys); i++) {
                fail_if(nc_hashmap_contains(map, bad_keys[i]),
                        "Config file contains unexpected key");
        }

        nc_hashmap_free(map);

        map = cve_parse_delim_file(TOP_DIR "/tests/bob/does/not/exist", ':');
        fail_if(map, "Non existent file should not parse");
        return;
}
END_TEST

START_TEST(cve_common_gunzip_sha_test)
{
        const char *expected = "82ee15b9459f7088e2a39b32d9e879c2bb6d08b0d13bb21f696fc2b38827fee1";
        const char *path = TOP_DIR "/tests/data/common/Test.gz";
        const char *out_path = TOP_BUILD_DIR "/tests/data/common/Test.gunzip";
        autofree(char) *hash = NULL;

        /** Just for sanity */
        nc_mkdir_p(TOP_BUILD_DIR "/tests/data/common/", 00755);

        fail_if(!cve_gunzip_file(path, out_path, 00644), "Failed to gunzip file");
        fail_if(!nc_file_exists(out_path), "Gunzip'd file does not exist");

        hash = cve_get_sha256sum(out_path);
        fail_if(!hash, "Failed to get hashsum");

        fail_if(!streq(expected, hash), "Expected hash does not match that of gunzip'd file");
}
END_TEST

static Suite *core_suite(void)
{
        Suite *s = NULL;
        TCase *tc = NULL;

        s = suite_create("cve_common");
        tc = tcase_create("cve_common_functions");
        tcase_add_test(tc, cve_common_parser);
        tcase_add_test(tc, cve_common_gunzip_sha_test);
        suite_add_tcase(s, tc);

        return s;
}

int main(void)
{
        Suite *s;
        SRunner *sr;
        int fail;

        s = core_suite();
        sr = srunner_create(s);
        srunner_run_all(sr, CK_VERBOSE);
        fail = srunner_ntests_failed(sr);
        srunner_free(sr);

        if (fail > 0) {
                return EXIT_FAILURE;
        }

        return EXIT_SUCCESS;
}

/*
 * Editor modelines  -  https://www.wireshark.org/tools/modelines.html
 *
 * Local variables:
 * c-basic-offset: 8
 * tab-width: 8
 * indent-tabs-mode: nil
 * End:
 *
 * vi: set shiftwidth=8 tabstop=8 expandtab:
 * :indentSize=8:tabSize=8:noTabs=true:
 */
